<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tài xế - Quản lý đơn hàng</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f0f2f5; }
        #map { height: 300px; width: 100%; border-bottom: 2px solid #00b14f; }
        .container { padding: 15px; }
        .order-card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px; display: none; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 5px; font-weight: bold; font-size: 16px; cursor: pointer; color: white; margin-top: 10px; }
        .btn-blue { background: #3498db; }
        .btn-green { background: #00b14f; }
        .btn-red { background: #e74c3c; }
        .status-text { font-weight: bold; color: #00b14f; text-align: center; display: block; margin-top: 10px; }
        #history-section { background: white; padding: 10px; border-radius: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { padding: 8px; border-bottom: 1px solid #ddd; text-align: left; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="container">
    <div id="active-order-card" class="order-card">
        <h3 id="order-title">Đơn hàng mới nhận</h3>
        <p>Hàng hóa: <b id="info-item">---</b></p>
        <p>Thu hộ (COD): <b id="info-price">0</b> VND</p>
        <p>Điểm giao: <span id="info-dest">---</span></p>
        
        <span id="current-status" class="status-text">TRẠNG THÁI: CHỜ LẤY HÀNG</span>

        <button id="btn-step1" class="btn btn-blue" onclick="processStep(1)">XÁC NHẬN ĐÃ LẤY HÀNG</button>
        <button id="btn-step2" class="btn btn-green" onclick="processStep(2)" style="display:none;">XÁC NHẬN ĐÃ GIAO XONG</button>
        
        <div id="photo-section" style="display:none; margin-top: 10px;">
            <p>Chụp ảnh xác nhận giao hàng:</p>
            <input type="file" id="photo-input" accept="image/*" capture="camera">
            <button class="btn btn-red" onclick="processStep(3)">HOÀN THÀNH & GỬI ẢNH</button>
        </div>
    </div>

    <div id="history-section">
        <h4>Lịch sử đơn hàng của bạn</h4>
        <table id="history-table">
            <thead>
                <tr><th>STT</th><th>Đơn hàng</th><th>Thời gian</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="/socket.io/socket.io.js"></script>

<script>
    const socket = io();
    let map, driverMarker, currentOrder = null;
    let locationInterval = null;

    // Khởi tạo bản đồ
    map = L.map('map').setView([10.0159, 105.7620], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // 1. LẮNG NGHE ĐƠN HÀNG MỚI TỪ NGƯỜI TẠO
    socket.on('new-order-alert', (data) => {
        const sound = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
        sound.play(); // Phát tiếng chuông thông báo

        const accept = confirm(`BẠN CÓ ĐƠN HÀNG MỚI!\nHàng: ${data.total}đ\nTừ: ${data.sender}\nĐến: ${data.receiver}\nBạn có nhận không?`);
        
        if (accept) {
            currentOrder = data;
            showOrderCard(data);
            // Báo cho Server là tài xế đã nhận đơn và đang đi lấy hàng
            socket.emit('update-order-status', { status: 'picking' });
        }
    });

    function showOrderCard(data) {
        document.getElementById('active-order-card').style.display = 'block';
        document.getElementById('info-item').innerText = "Đơn hàng #" + data.id;
        document.getElementById('info-price').innerText = data.total;
        document.getElementById('info-dest').innerText = `${data.dropoff.lat.toFixed(4)}, ${data.dropoff.lng.toFixed(4)}`;
    }

    // 2. QUY TRÌNH XỬ LÝ 3 BƯỚC
    function processStep(step) {
        if (step === 1) { // Đã lấy được hàng -> Chuyển sang đang giao
            document.getElementById('current-status').innerText = "TRẠNG THÁI: ĐANG GIAO HÀNG";
            document.getElementById('btn-step1').style.display = 'none';
            document.getElementById('btn-step2').style.display = 'block';
            
            socket.emit('update-order-status', { status: 'delivering' });
            startTracking(); // Bắt đầu phát vị trí cho khách xem
        } 
        else if (step === 2) { // Đã giao xong -> Hiện phần chụp ảnh
            document.getElementById('btn-step2').style.display = 'none';
            document.getElementById('photo-section').style.display = 'block';
        } 
        else if (step === 3) { // Gửi ảnh và hoàn thành
            const file = document.getElementById('photo-input').files[0];
            if (!file) return alert("Vui lòng chụp ảnh xác nhận!");

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function () {
                const base64Image = reader.result;
                
                // Gửi trạng thái cuối cùng kèm ảnh về Server
                socket.emit('update-order-status', { 
                    status: 'finished',
                    photo: base64Image
                });

                stopTracking();
                addToHistory();
                alert("Chúc mừng! Bạn đã hoàn thành đơn hàng.");
                location.reload(); // Refresh trang để sẵn sàng đơn mới
            };
        }
    }

    // 3. THEO DÕI VỊ TRÍ
    function startTracking() {
        if (navigator.geolocation) {
            locationInterval = setInterval(() => {
                navigator.geolocation.getCurrentPosition((pos) => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    
                    // Vẽ lên map tài xế
                    if (!driverMarker) driverMarker = L.marker([lat, lng]).addTo(map);
                    else driverMarker.setLatLng([lat, lng]);
                    map.setView([lat, lng]);

                    // Gửi tọa độ lên server cho khách xem
                    socket.emit('send-location', { currentPos: {lat, lng} });
                });
            }, 3000);
        }
    }

    function stopTracking() {
        clearInterval(locationInterval);
    }

    function addToHistory() {
        const table = document.getElementById('history-table').getElementsByTagName('tbody')[0];
        const row = table.insertRow(0);
        row.innerHTML = `<td>1</td><td>${currentOrder.total}đ</td><td>${new Date().toLocaleTimeString()}</td>`;
    }
</script>
</body>
</html>